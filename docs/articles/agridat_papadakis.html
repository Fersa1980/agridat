<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Papadakis covariates for nearest neighbor analysis • agridat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Papadakis covariates for nearest neighbor analysis">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">agridat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.17</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/agridat_data.html">Additional sources of agricultural data</a>
    </li>
    <li>
      <a href="../articles/agridat_examples.html">Graphical Gems in the agridat Package</a>
    </li>
    <li>
      <a href="../articles/agridat_papadakis.html">Using Papadakis covariates for nearest neighbor analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using Papadakis covariates for nearest neighbor analysis</h1>
                        <h4 class="author">Kevin Wright</h4>
            
            <h4 class="date">2019-09-13</h4>
      
      
      <div class="hidden name"><code>agridat_papadakis.Rmd</code></div>

    </div>

    
    
<div id="r-setup" class="section level1">
<h1 class="hasAnchor">
<a href="#r-setup" class="anchor"></a>R setup</h1>
<p><span class="citation">Papadakis (1937)</span> believed that traditional blocking in field experiments did not adequately represent the patchiness of soil fertility patterns and he instead proposed adjusting the yield of each plot by the performance of the neighboring plots.</p>
<p>If there is heterogeneity in the field that is of a scale smaller than the block (but larger than the individual plots) then adjacent plots will be positively correlated and this information about the neighboring plots can be used to reduce the effect of spatial heterogeneity and increase the accuracy of the treatment effects.</p>
<p>The Papadakis method is a nearest neighbor method that uses a residual covariate in the analysis. In essence, the method follows the following steps.</p>
<ol style="list-style-type: decimal">
<li><p>Fit a treatment model and calculate the residuals from the model.</p></li>
<li><p>Calculate covariates that are the average of the neighboring residuals.</p></li>
<li><p>Fit a model with additional covariate terms for the residuals.</p></li>
</ol>
<p>The left-right (LR) covariate for the (i,j)th plot is the average of the residuals for the plots immediately to the left and right of the (i,j)th plot. If one of these neighbors is missing, then the covariate is constructed from the single remaining neighboring residual. Border plots use only one neighboring residual. The up-down (UD) covariate is similarly constructed from residuals for plots immediately up or down from the (i,j)th plot.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">papcov &lt;-<span class="st"> </span><span class="cf">function</span>(resid,x,y){</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="co"># Make sure x and y are numeric</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span>(x)) x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(x))</a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span>(y)) y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(y))</a>
<a class="sourceLine" id="cb1-6" title="6">  xy &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(x,y,<span class="dt">sep=</span><span class="st">":"</span>)</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="co"># Average neighboring residuals in up/down direction</span></a>
<a class="sourceLine" id="cb1-9" title="9">  xym1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(x,y<span class="dv">-1</span>,<span class="dt">sep=</span><span class="st">":"</span>)</a>
<a class="sourceLine" id="cb1-10" title="10">  xyp1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(x,y<span class="op">+</span><span class="dv">1</span>,<span class="dt">sep=</span><span class="st">":"</span>)</a>
<a class="sourceLine" id="cb1-11" title="11">  rm1 &lt;-<span class="st"> </span>resid[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(xym1,xy,<span class="ot">NA</span>)]</a>
<a class="sourceLine" id="cb1-12" title="12">  rp1 &lt;-<span class="st"> </span>resid[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(xyp1,xy,<span class="ot">NA</span>)]</a>
<a class="sourceLine" id="cb1-13" title="13">  ud &lt;-<span class="st"> </span>(rm1<span class="op">+</span>rp1)<span class="op">/</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-14" title="14">  <span class="co"># If only one neighboring residual is available, then just use it</span></a>
<a class="sourceLine" id="cb1-15" title="15">  ud &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(ud) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(rm1),rm1,ud)</a>
<a class="sourceLine" id="cb1-16" title="16">  ud &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(ud) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(rp1),rp1,ud)</a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="co"># Average neighboring residuals in left/right direction</span></a>
<a class="sourceLine" id="cb1-19" title="19">  xm1y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(x<span class="dv">-1</span>,y,<span class="dt">sep=</span><span class="st">":"</span>)</a>
<a class="sourceLine" id="cb1-20" title="20">  xp1y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(x<span class="op">+</span><span class="dv">1</span>,y,<span class="dt">sep=</span><span class="st">":"</span>)</a>
<a class="sourceLine" id="cb1-21" title="21">  cm1 &lt;-<span class="st"> </span>resid[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(xm1y,xy,<span class="ot">NA</span>)]</a>
<a class="sourceLine" id="cb1-22" title="22">  cp1 &lt;-<span class="st"> </span>resid[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(xp1y,xy,<span class="ot">NA</span>)]</a>
<a class="sourceLine" id="cb1-23" title="23">  lr &lt;-<span class="st"> </span>(cm1<span class="op">+</span>cp1)<span class="op">/</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-24" title="24">  <span class="co"># If only one neighboring residual is available, then just use it</span></a>
<a class="sourceLine" id="cb1-25" title="25">  lr &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(lr) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(cm1),cm1,lr)</a>
<a class="sourceLine" id="cb1-26" title="26">  lr &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(lr) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(cp1),cp1,lr)</a>
<a class="sourceLine" id="cb1-27" title="27"></a>
<a class="sourceLine" id="cb1-28" title="28">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">LR=</span>lr, <span class="dt">UD=</span>ud))</a>
<a class="sourceLine" id="cb1-29" title="29">}</a></code></pre></div>
</div>
<div id="reproduce-hinz-1987-case-2" class="section level1">
<h1 class="hasAnchor">
<a href="#reproduce-hinz-1987-case-2" class="anchor"></a>Reproduce Hinz 1987 case 2</h1>
<p><span class="citation">Hinz (1987)</span> used the Papadakis technique to analzye a field experiment of tobacco.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"agridat"</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(federer.tobacco)</a>
<a class="sourceLine" id="cb2-3" title="3">dat &lt;-<span class="st"> </span>federer.tobacco</a>
<a class="sourceLine" id="cb2-4" title="4">dat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(dat, <span class="dt">height=</span>height<span class="dv">-600</span>) <span class="co"># For simplicity</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co"># Model 1 - RCB</span></a>
<a class="sourceLine" id="cb2-7" title="7">m1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(height <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(block) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(dose), dat)</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span>(m1)</a></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: height
##               Df  Sum Sq Mean Sq F value Pr(&gt;F)
## factor(block)  7  388315   55474  1.8352 0.1056
## factor(dose)   6  273875   45646  1.5100 0.1985
## Residuals     42 1269586   30228</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># Model 2 - Row/Col as class variables</span></a>
<a class="sourceLine" id="cb4-2" title="2">m2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(height <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(block) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(dose) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(row), dat)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span>(m2)</a></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: height
##               Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## factor(block)  7  388315   55474  7.5455 1.355e-05 ***
## factor(dose)   6  273875   45646  6.2088 0.0001521 ***
## factor(row)    6 1004920  167487 22.7816 6.767e-11 ***
## Residuals     36  264666    7352                      
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Model 3 - Two-step Papadakis</span></a>
<a class="sourceLine" id="cb6-2" title="2">m3 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(height <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(dose), dat)</a>
<a class="sourceLine" id="cb6-3" title="3">dat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(dat, <span class="kw">papcov</span>(m3<span class="op">$</span>resid, dat<span class="op">$</span>block, dat<span class="op">$</span>row))</a>
<a class="sourceLine" id="cb6-4" title="4">m4 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(height <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(dose) <span class="op">+</span><span class="st"> </span>LR <span class="op">+</span><span class="st"> </span>UD, <span class="dt">data=</span>dat)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span>(m4)</a></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: height
##              Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## factor(dose)  6  273875   45646  3.6857  0.004407 ** 
## LR            1 1061352 1061352 85.6998 3.636e-12 ***
## UD            1   14477   14477  1.1689  0.285136    
## Residuals    47  582073   12385                      
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># Resid MS uses 1 df less to account for covariates.  Matches Hinz.</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="dv">582073</span> <span class="op">/</span><span class="st"> </span><span class="dv">46</span> </a></code></pre></div>
<pre><code>## [1] 12653.76</code></pre>
</div>
<div id="iterated-example-as-given-in-stroup-et-al-table-2" class="section level1">
<h1 class="hasAnchor">
<a href="#iterated-example-as-given-in-stroup-et-al-table-2" class="anchor"></a>Iterated example as given in Stroup et al, Table 2</h1>
<p><span class="citation">Stroup, Baenziger, and Mulitze (1994)</span> used the Papadakis tecnique in an iterative manner.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"agridat"</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(stroup.nin)</a>
<a class="sourceLine" id="cb10-3" title="3">dat2 &lt;-<span class="st"> </span>stroup.nin</a>
<a class="sourceLine" id="cb10-4" title="4">dat2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(dat2,<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(yield))</a>
<a class="sourceLine" id="cb10-5" title="5">n.gen &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span>(dat2<span class="op">$</span>gen)</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co"># RCB model, ranks match Stroup Table 2, RCB Alliance</span></a>
<a class="sourceLine" id="cb10-8" title="8">m5 &lt;-<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>rep, <span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb10-9" title="9">pred.rcb &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(m5)[<span class="dv">1</span><span class="op">:</span>n.gen] <span class="co"># RCB adj means</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="dv">57</span><span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rank.html">rank</a></span>(pred.rcb)))</a></code></pre></div>
<pre><code>##    genNE86503    genNE87619    genNE86501    genRedland  genCenturk78    genNE83498 
##             1             2             3             4             5             6 
##  genSiouxland    genNE86606   genArapahoe    genNE87613    genNE86607     genLancer 
##             7             8             9            10            11            12 
##     genTAM107   genCheyenne    genNE87446  genHomestead    genScout66    genNE83404 
##            13            14            15            16            17            18 
##       genColt    genNE86509    genNE87513    genLancota    genNE85556    genNE87408 
##            19            20            21            22            23            24 
##      genBrule    genNE87463    genNE87615   genBuckskin    genNE87403    genNE87522 
##            25            26            27            28            29            30 
##    genNE87451    genNE86582       genGage     genNorkan    genNE86482    genNE83406 
##            31            32            33            34            35            36 
##   genKS831374    genNE87457    genNE86507       genVona    genNE87512    genNE87627 
##            37            38            39            40            41            42 
##    genNE83407    genNE86527    genNE87612    genNE85623    genCentura    genNE83T12 
##            43            44            45            46            47            48 
##   genNE86T666    genNE87409     genTAM200       genCody genRoughrider    genNE84557 
##            49            50            51            52            53            54 
##    genNE87499    genNE83432 
##            55            56</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co"># Initial genotype model (no blocks)</span></a>
<a class="sourceLine" id="cb12-2" title="2">m6 &lt;-<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="dv">-1</span>, <span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co"># Calculate Papadakis covariates</span></a>
<a class="sourceLine" id="cb12-4" title="4">pp &lt;-<span class="st"> </span><span class="kw">papcov</span>(<span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span>(m6), dat2<span class="op">$</span>col, dat2<span class="op">$</span>row)</a>
<a class="sourceLine" id="cb12-5" title="5">dat2<span class="op">$</span>LR &lt;-<span class="st"> </span>pp<span class="op">$</span>LR</a>
<a class="sourceLine" id="cb12-6" title="6">dat2<span class="op">$</span>UD &lt;-<span class="st"> </span>pp<span class="op">$</span>UD</a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co"># Single iteration of Papadakis model</span></a>
<a class="sourceLine" id="cb12-8" title="8">m7 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>LR <span class="op">+</span><span class="st"> </span>UD, <span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co"># Papadakis adjusted means</span></a>
<a class="sourceLine" id="cb12-10" title="10">adjmn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(m7)[<span class="dv">1</span><span class="op">:</span>n.gen]</a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co"># Residual = observed - adjusted mean</span></a>
<a class="sourceLine" id="cb12-12" title="12">resid &lt;-<span class="st"> </span>dat2<span class="op">$</span>yield <span class="op">-</span><span class="st"> </span>adjmn[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"gen"</span>,dat2<span class="op">$</span>gen),<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(adjmn))]</a>
<a class="sourceLine" id="cb12-13" title="13"></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co"># Now iterate Papadakis method to convergence</span></a>
<a class="sourceLine" id="cb12-15" title="15">iter &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb12-16" title="16">notConv &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="cf">while</span>(notConv){</a>
<a class="sourceLine" id="cb12-18" title="18">  iter &lt;-<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb12-19" title="19">  <span class="co"># Covariates based on residuals</span></a>
<a class="sourceLine" id="cb12-20" title="20">  pp &lt;-<span class="st"> </span><span class="kw">papcov</span>(resid, dat2<span class="op">$</span>col, dat2<span class="op">$</span>row)</a>
<a class="sourceLine" id="cb12-21" title="21">  dat2<span class="op">$</span>LR &lt;-<span class="st"> </span>pp<span class="op">$</span>LR</a>
<a class="sourceLine" id="cb12-22" title="22">  dat2<span class="op">$</span>UD &lt;-<span class="st"> </span>pp<span class="op">$</span>UD</a>
<a class="sourceLine" id="cb12-23" title="23">  m8 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>LR <span class="op">+</span><span class="st"> </span>UD, <span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb12-24" title="24">  <span class="co"># Check convergence of adjusted means</span></a>
<a class="sourceLine" id="cb12-25" title="25">  prevmn &lt;-<span class="st"> </span>adjmn</a>
<a class="sourceLine" id="cb12-26" title="26">  adjmn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(m8)[<span class="dv">1</span><span class="op">:</span>n.gen]</a>
<a class="sourceLine" id="cb12-27" title="27">  tol &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((adjmn <span class="op">-</span><span class="st"> </span>prevmn)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-28" title="28">  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Iteration: "</span>,iter,<span class="st">" tol: "</span>,tol,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb12-29" title="29">  notConv &lt;-<span class="st"> </span>tol <span class="op">&gt;</span><span class="st"> </span><span class="fl">.001</span></a>
<a class="sourceLine" id="cb12-30" title="30">  resid &lt;-<span class="st"> </span>dat2<span class="op">$</span>yield <span class="op">-</span><span class="st"> </span>adjmn[<span class="kw"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"gen"</span>,dat2<span class="op">$</span>gen),<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(adjmn))]</a>
<a class="sourceLine" id="cb12-31" title="31">}</a></code></pre></div>
<pre><code>## Iteration:  1  tol:  51.60518 
## Iteration:  2  tol:  7.823055 
## Iteration:  3  tol:  1.445812 
## Iteration:  4  tol:  0.3619413 
## Iteration:  5  tol:  0.09555693 
## Iteration:  6  tol:  0.02840853 
## Iteration:  7  tol:  0.008783593 
## Iteration:  8  tol:  0.003297561 
## Iteration:  9  tol:  0.001650757 
## Iteration:  10  tol:  0.001157637 
## Iteration:  11  tol:  0.001000046 
## Iteration:  12  tol:  0.0009401906</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">pred.pap &lt;-<span class="st"> </span>adjmn</a>
<a class="sourceLine" id="cb14-2" title="2"></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co"># Ranks almost match Stroup et al, Table 2, Alliance, RCB+NNA-PAP</span></a>
<a class="sourceLine" id="cb14-4" title="4">all &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">rcb=</span><span class="dv">57</span><span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/rank.html">rank</a></span>(pred.rcb), <span class="dt">nna=</span><span class="dv">57</span><span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/rank.html">rank</a></span>(pred.pap))</a>
<a class="sourceLine" id="cb14-5" title="5">all[<span class="kw"><a href="https://rdrr.io/r/base/order.html">order</a></span>(all<span class="op">$</span>rcb),]</a></code></pre></div>
<pre><code>##               rcb nna
## genNE86503      1  14
## genNE87619      2   4
## genNE86501      3  24
## genRedland      4   6
## genCenturk78    5  15
## genNE83498      6   2
## genSiouxland    7  28
## genNE86606      8  11
## genArapahoe     9  18
## genNE87613     10   9
## genNE86607     11  16
## genLancer      12  35
## genTAM107      13  37
## genCheyenne    14  21
## genNE87446     15  46
## genHomestead   16  44
## genScout66     17  13
## genNE83404     18  23
## genColt        19  17
## genNE86509     20  42
## genNE87513     21  45
## genLancota     22  49
## genNE85556     23   3
## genNE87408     24  36
## genBrule       25   7
## genNE87463     26  39
## genNE87615     27  32
## genBuckskin    28   1
## genNE87403     29  53
## genNE87522     30  52
## genNE87451     31  33
## genNE86582     32  48
## genGage        33  29
## genNorkan      34  51
## genNE86482     35  25
## genNE83406     36  19
## genKS831374    37   5
## genNE87457     38  34
## genNE86507     39  10
## genVona        40  30
## genNE87512     41  47
## genNE87627     42  55
## genNE83407     43  27
## genNE86527     44   8
## genNE87612     45  20
## genNE85623     46  31
## genCentura     47  26
## genNE83T12     48  40
## genNE86T666    49  56
## genNE87409     50  12
## genTAM200      51  54
## genCody        52  43
## genRoughrider  53  22
## genNE84557     54  38
## genNE87499     55  41
## genNE83432     56  50</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># Visually compare the coefficients from the two methods</span></a>
<a class="sourceLine" id="cb16-2" title="2">lims=<span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(pred.rcb,pred.pap))</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pred.rcb, pred.pap, <span class="dt">xlim=</span>lims, <span class="dt">ylim=</span>lims,</a>
<a class="sourceLine" id="cb16-4" title="4">     <span class="dt">xlab=</span><span class="st">"RCB"</span>,<span class="dt">ylab=</span><span class="st">"Papadakis"</span>,<span class="dt">type=</span><span class="st">'n'</span>)</a>
<a class="sourceLine" id="cb16-5" title="5"><span class="kw"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(pred.rcb,pred.pap, <span class="kw"><a href="https://rdrr.io/r/base/substr.html">substring</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pred.rcb),<span class="dv">4</span>),<span class="dt">cex=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb16-6" title="6"><span class="kw"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Iterated Papadakis vs. RCB"</span>)</a>
<a class="sourceLine" id="cb16-7" title="7"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dv">0</span>,<span class="dv">1</span>)</a></code></pre></div>
<p><img src="agridat_papadakis_files/figure-html/stroup-1.png" width="576"> The variety ‘Buckskin’ has a large adjustment when using the Papadakis method. This makes sense, because Buckskin ended up in the high-yielding part of each of the four reps.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-hinz1987nearest">
<p>Hinz, Paul N. 1987. “Nearest-Neighbor Analysis in Practice.” <em>Iowa State Journal of Research</em> 62: 199–217.</p>
</div>
<div id="ref-papadakis1937method">
<p>Papadakis, J S. 1937. “Méthode Statistique Pour Les Expériences En Champ.” <em>Bulletin Institute de L’Ameloration Des Plantes à Salonique</em> 23.</p>
</div>
<div id="ref-stroup1994removing">
<p>Stroup, Walter, P Stephen Baenziger, and Dieter K Mulitze. 1994. “Removing Spatial Variation from Wheat Yield Trials: A Comparison of Methods.” <em>Crop Science</em> 86: 62–66.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-setup">R setup</a></li>
      <li><a href="#reproduce-hinz-1987-case-2">Reproduce Hinz 1987 case 2</a></li>
      <li><a href="#iterated-example-as-given-in-stroup-et-al-table-2">Iterated example as given in Stroup et al, Table 2</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin Wright.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
